{% extends 'header_2.html' %}

{% block content %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Received Proposals</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <style>
/* General Styling */
body {
  font-family: 'Poppins', sans-serif;
  margin: 0;
  background-color: #f0f2f5;
  color: #333;
}

/* Proposals Container */
.proposals-container {
  width: 85%;
  max-width: 1000px;
  background: #fff;
  margin: 40px auto;
  border-radius: 15px;
  box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
  overflow: hidden;
  padding: 30px;
}

/* Header Section */
.proposals-header {
  text-align: center;
  border-bottom: 2px solid #ececec;
  padding-bottom: 20px;
  margin-bottom: 20px;
}

.proposals-header h2 {
  font-size: 28px;
  color: #333;
  font-weight: 600;
  margin: 0;
}

/* Proposal List */
.proposal-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

.proposal-item {
  background: #f9f9f9;
  padding: 20px;
  border-radius: 15px;
  margin-bottom: 20px;
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.proposal-item:hover {
  transform: scale(1.02);
  box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
}

.proposal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.proposal-header h3 {
  font-size: 22px;
  color: #333;
  margin: 0;
}

.proposal-header span {
  padding: 5px 10px;
  border-radius: 5px;
  color: white;
  font-size: 12px;
}

.proposal-header .status-open {
  background-color: #4caf50;
}

.proposal-header .status-closed {
  background-color: #f44336;
}

.proposal-body {
  margin-bottom: 10px;
}

.proposal-body p {
  font-size: 16px;
  color: #555;
  margin: 0;
}

.proposal-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 14px;
  color: #666;
}

.proposal-footer span {
  display: flex;
  align-items: center;
}

.proposal-footer i {
  margin-right: 5px;
  color: #1565c0;
}

.button-group {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin-top: 10px;
}

.view-details, .view-profile {
  padding: 12px 24px;
  background-color: #1565c0;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 12px;
  text-decoration: none;
  transition: background-color 0.3s ease, transform 0.3s ease;
  text-align: center;
}

.view-details:hover, .view-profile:hover {
  background-color: #104a8e;
  transform: scale(1.05);
}

/* Popup Modal */
.modal {
  display: none;
  position: fixed;
  z-index: 1;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0, 0, 0, 0.5);
}

.modal-content {
  background-color: #fff;
  margin: 5% auto;
  padding: 20px;
  border: 1px solid #888;
  border-radius: 10px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
  width: 80%;
  max-width: 700px;
  text-align: left;
  animation: slideIn 0.5s ease;
}

@keyframes slideIn {
  from {
    transform: translateY(-50px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

.modal-content .close {
  color: #aaa;
  float: right;
  font-size: 28px;
  font-weight: bold;
}

.modal-content .close:hover,
.modal-content .close:focus {
  color: black;
  text-decoration: none;
  cursor: pointer;
}

.modal-description {
  font-size: 1.1em;
  line-height: 1.6;
  color: #555;
  margin-bottom: 20px;
}

.modal-description img {
  border-radius: 50%;
  margin-bottom: 20px;
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.modal-description .row {
  display: flex;
  justify-content: space-between;
  margin-bottom: 10px;
}

.modal-description .row p {
  flex: 1;
  margin: 0 10px;
}

.modal-description .row p strong {
  color: #333;
}

.modal-description .full-width {
  margin-bottom: 10px;
}

.modal-description .full-width p {
  margin: 0;
}

.modal-description .full-width p strong {
  color: #333;
}

.approve-button {
  display: block;
  margin: 20px auto 0;
  padding: 12px 24px;
  background-color: #4caf50;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  text-align: center;
  transition: background-color 0.3s ease, transform 0.3s ease;
}

.approve-button:hover {
  background-color: #388e3c;
  transform: scale(1.05);
}

/* Responsive Design */

/* Responsive Design for Mobile */
@media (max-width: 768px) {
  .proposals-container {
    width: 90%;
    padding: 15px;
  }

  .proposals-header h2 {
    font-size: 24px;
  }

  .proposal-item {
    padding: 15px;
  }

  .proposal-header h3 {
    font-size: 20px;
  }

  .proposal-body p {
    font-size: 14px;
  }

  .proposal-footer {
    flex-direction: column;
    align-items: flex-start;
  }

  .view-details, .view-profile {
    padding: 10px 20px;
    font-size: 14px;
  }

  .modal-content {
    width: 90%;
  }

  .modal-description .row {
    flex-direction: column;
  }

  .modal-description .row p {
    margin: 5px 0;
  }
}

/* Responsive Design for Small Mobile Devices */
@media (max-width: 480px) {
  .proposals-container {
    width: 100%;
    padding: 10px;
  }

  .proposals-header h2 {
    font-size: 20px;
  }

  .proposal-item {
    padding: 10px;
  }

  .proposal-header h3 {
    font-size: 18px;
  }

  .proposal-body p {
    font-size: 12px;
  }

  .proposal-footer {
    flex-direction: column;
    align-items: flex-start;
    font-size: 12px;
  }

  .view-details, .view-profile {
    padding: 8px 16px;
    font-size: 12px;
  }

  .modal-content {
    width: 95%;
  }

  .modal-description .row {
    flex-direction: column;
  }

  .modal-description .row p {
    margin: 5px 0;
  }
}
  </style>
</head>
<body>
  <div class="proposals-container">
    <div class="proposals-header">
      <h2>Received Proposals</h2>
    </div>
    <ul class="proposal-list">
      {% for proposal in proposals %}
      <li class="proposal-item">
        <div class="proposal-header">
          <h3>{{ proposal.freelancer.first_name }} {{ proposal.freelancer.last_name }}</h3>
          <span class="status-open">Open</span>
        </div>
        <div class="proposal-body">
          <p>{{proposal.description| truncatechars:200}}</p>
        </div>
        <div class="proposal-footer">
          <span><i class="fas fa-calendar-alt"></i> Submitted on: {{ proposal.submitted_at|date:"M d, Y" }}</span>
        </div>
        <div class="button-group">
          <button class="view-details" onclick="viewDetails('{{ proposal.title }}', '{{ proposal.description }}', '{{ proposal.duration }}', '{{ proposal.bid }}', '{{ proposal.cover_letter }}', '{{ proposal.attachment}}', '{{ proposal.submitted_at|date:"Y-m-d H:i:s" }}')">View Details</button>
          <button class="view-profile" onclick="viewProfile(  '{{ proposal.freelancer.profile.url|escapejs }}',   '{{ proposal.freelancer.first_name|escapejs }} {{ proposal.freelancer.last_name|escapejs }}',   '{{ proposal.freelancer.hourly_rate|escapejs }}',   '{{ proposal.freelancer.email|escapejs }}',   '{{ proposal.freelancer.phone_number|escapejs }}',   '{{ proposal.freelancer.skills|escapejs }}',   '{{ proposal.freelancer.location|escapejs }}',   '{{ proposal.freelancer.about_me|escapejs }}')">View Profile</button>
          <a href="javascript:void(0);" class="select-project-button" onclick="startPayment({{proposal.id}}, {{proposal.bid}})">Approve and Payment </a>
          print({{proposal.id}})
        </div>        
      </li>
      {% endfor %}
    </ul>
  </div>

<!-- Profile Modal -->
<div id="profileModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('profileModal')">&times;</span>
    <div class="modal-description" id="profileDetails">
      <!-- Profile details will be dynamically inserted here -->
    </div>
  </div>
</div> 

<!-- Details Modal -->
<div id="detailsModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('detailsModal')">&times;</span>
    <div class="modal-description" id="detailsContent">
      <!-- Proposal details will be dynamically inserted here -->
    </div>
    <!-- Select Project Button (Triggers Razorpay Payment) -->
      {% if selected_proposal %}
    <a href="javascript:void(0);" class="select-project-button" onclick="startPayment({{project_id}})">Approve and Payment </a>
    print({{project_id}})
    {% endif %}
  </div>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
    // Function to open a modal
    function openModal(modalId) {
        var modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = "block";
        }
    }

    // Function to close a modal
    function closeModal(modalId) {
        var modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = "none";
        }
    }

    // Start Razorpay Payment
    function startPayment(proposalId, bid) {
        // Fetch CSRF token
        const csrfToken = document.getElementById('csrf_token').value;

        // Make a request to create the Razorpay order
        fetch("{% url 'create_order' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ proposal_id: proposalId, bid: bid})
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                //alert('Error creating order: ' + data.error);
                alert("Internal Server Error, Try again after few moments")
                return;
            }

            var options = {
                key: '{{ RAZORPAY_KEY }}',  // Your Razorpay key
                amount: data.amount,        // Amount in paise
                currency: 'INR',
                name: 'WorkSphere',
                description: 'Payment for project proposal: ' + proposalId,
                order_id: data.order_id,    // Razorpay order ID
                handler: function (response) {
                    // Send payment details for verification
                    fetch("{% url 'verify_payment' %}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({
                            razorpay_order_id: response.razorpay_order_id,
                            razorpay_payment_id: response.razorpay_payment_id,
                            razorpay_signature: response.razorpay_signature
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            alert('Payment Successful!');
                            window.location.href = "{% url 'client_dashboard' %}"; // Redirect to success page
                        } else {
                            alert('Payment verification failed: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error verifying payment:', error);
                        alert('An error occurred during payment verification.');
                    });
                },
                prefill: {
                    name: "{{ user.username }}", // Pre-filled name from Django user object
                    email: "{{ user.email }}",   // Pre-filled email from Django user object
                    contact: "{{ user.phone_no }}" // Pre-filled contact number (assuming a 'phone_number' field in your user's profile)
                },
                theme: {
                    color: "#F37254" // Customize color
                }
            };

            // Open Razorpay payment modal
            var rzp1 = new Razorpay(options);
            rzp1.open();
        })
        .catch(error => {
            console.error('Error creating order:', error);
            alert('An error occurred while initiating the payment.');
        });
    }
  
  // Function to show proposal details in the modal
  function viewDetails(title, description, duration, bid, coverLetter, attachmentUrl, submittedAt) {
    const modalDetails = `
     <h3>Proposal Details</h3>
      <p><strong>Title:</strong> ${title}</p>
      <div class="row" style=" margin-bottom: 10px; justify-content: space-between;">
        <p style="margin: 0; flex-basis: 45%;"><strong>Description:</strong> ${description.length > 100 ? description.substring(0, 100) + '...' : description}</p>
      </div>
      <p><strong>Duration:</strong> ${duration}</p>
      <p><strong>Bid:</strong> $${bid}</p>
           <div class="row" style=" margin-bottom: 10px; justify-content: space-between;">
        <p style="margin: 0; flex-basis: 45%;"><strong>Cover Letter:</strong> ${coverLetter.length > 2000 ? coverLetter.substring(0, 2000) + '...' : coverLetter}</p>
      </div>
      ${attachmentUrl ? `<p><strong>Attachment:</strong> <a href="${attachmentUrl}" target="_blank">Download</a></p>` : ''}
      <p><strong>Submitted At:</strong> ${submittedAt}</p>

    `;
    document.getElementById('detailsContent').innerHTML = modalDetails;
    document.getElementById('detailsModal').style.display = 'block';
  }

  // Function to show freelancer profile in the modal
  function viewProfile(profileUrl, name, rate, email, phone, skills, location, bio) {
    const modalProfile = `
    <div style="text-align: center; margin-bottom: 20px;">
        <img src="${profileUrl}" alt="Profile Photo" width="150" height="150" style="border-radius: 50%; border: 2px solid #ddd;">
      </div>
      <div class="row" style="display: flex; margin-bottom: 10px; justify-content: space-between;">
        <p style="margin: 0; flex-basis: 45%;"><strong>Name:</strong> ${name}</p>
        <p style="margin: 0; flex-basis: 45%;"><strong>Hourly Rate:</strong> ${rate}</p>
      </div>
      <div class="row" style="display: flex; margin-bottom: 10px; justify-content: space-between;">
        <p style="margin: 0; flex-basis: 45%;"><strong>Email:</strong> ${email}</p>
        <p style="margin: 0; flex-basis: 45%;"><strong>Phone:</strong> ${phone}</p>
      </div>
      <div class="row" style="display: flex; margin-bottom: 10px; justify-content: space-between;">
        <p style="margin: 0; flex-basis: 45%;"><strong>Skills:</strong> ${skills}</p>
        <p style="margin: 0; flex-basis: 45%;"><strong>Location:</strong> ${location}</p>
      </div>
      <div class="full-width" style="margin-bottom: 10px;">
        <p><strong>Bio:</strong> ${bio.length > 200 ? bio.substring(0, 200) + '...' : bio}</p>
      </div>
    `;
    document.getElementById('profileDetails').innerHTML = modalProfile;
    document.getElementById('profileModal').style.display = 'block';
  }

  // Function to close the modal
  function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
  }
</script>
<!-- CSRF Token -->
<input type="hidden" id="csrf_token" value="{{ csrf_token }}">
</body>
</html>
{% endblock %}
