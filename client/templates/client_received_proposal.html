{% extends 'header_2.html' %}

{% block content %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Confirm Proposal</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <style>
    body {
      margin: 0;
      background-color: #f0f2f5;
      color: #333;
    }

    .proposals-container {
      max-width: 1000px;
      background: #fff;
      margin: 40px auto;
      border-radius: 15px;
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      padding: 30px;
    }

    .proposals-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid #ececec;
      padding-bottom: 20px;
      margin-bottom: 20px;
    }

    .proposals-header h2 {
      font-size: 40px;
      font-family: Candara;
      color: #007bff;
      font-weight: 700;
      margin: 0;
      text-align: center;
      width: 100%;
    }

    .proposal-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .proposal-item {
      background: #f9f9f9;
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 20px;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .proposal-item:hover {
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
    }

    .proposal-header {
      display: grid;
      grid-template-columns: auto auto; /* Two columns */
      column-gap: 10px; /* Space between columns */
      row-gap: 10px; /* Space between rows */
      align-items: center; /* Align text in the middle */
      width: fit-content;
    }
    
    .proposal-header h3 {
      font-size: 18px;
      font-family: Candara;
      color: #007bff;
      margin: 0;
      font-weight: bold;
    }
    
    .proposal-header p {
      font-size: 18px;
      color: #666;
      font-family: Candara;
      margin: 0;
      text-align: left; /* Align values to the left */
    }
    
    .details-section {
      margin-bottom: 40px;
    }

    .details-section .info-group {
      display: flex;
      align-items: center;
      margin: 10px 0;
    }

    .details-section label {
      font-weight: bold;
      color: #333;
      font-family: Candara;
      font-size: 16px;
      width: 150px;
      flex-shrink: 0;
      text-align: left;
    }

    .details-section span {
      color: #555;
      flex: 1;
      word-break: break-word;
      font-family: Candara;
      font-size: 16px;
    }

    .button-group {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
    }

.view-details {
  padding: 12px 24px;
  background-color: #1565c0;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 12px;
  font-family: Verdana;
  text-decoration: none;
  transition: background-color 0.3s ease, transform 0.3s ease;
  text-align: center;
}

.view-details:hover {
  background-color: #104a8e;
  transform: scale(1.05);
}

/* Popup Modal */
.modal {
  display: none;
  position: fixed;
  z-index: 1;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0, 0, 0, 0.5);
}

.modal-content {
  background-color: #fff;
  margin: 5% auto;
  padding: 20px;
  border: 1px solid #888;
  border-radius: 10px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
  width: 80%;
  max-width: 700px;
  text-align: left;
  animation: slideIn 0.5s ease;
}

@keyframes slideIn {
  from {
    transform: translateY(-50px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

.modal-content .close {
  color: #aaa;
  float: right;
  font-size: 28px;
  font-weight: bold;
}

.modal-content .close:hover,
.modal-content .close:focus {
  color: black;
  text-decoration: none;
  cursor: pointer;
}

.modal-description {
  font-size: 1.1em;
  line-height: 1.6;
  color: #555;
  margin-bottom: 20px;
}

.modal-description img {
  border-radius: 50%;
  margin-bottom: 20px;
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.modal-description .row {
  display: flex;
  justify-content: space-between;
  margin-bottom: 10px;
}

.modal-description .row p {
  flex: 1;
  margin: 0 10px;
}

.modal-description .row p strong {
  color: #333;
}

.modal-description .full-width {
  margin-bottom: 10px;
}

.modal-description .full-width p {
  margin: 0;
}

.modal-description .full-width p strong {
  color: #333;
}


/* Responsive Design */

/* Responsive Design for Mobile */
@media (max-width: 768px) {
  .proposals-container {
    width: 90%;
    padding: 15px;
  }

  .proposals-header h2 {
    font-size: 24px;
  }

  .proposal-item {
    padding: 15px;
  }

  .proposal-header h3 {
    font-size: 20px;
  }

  .proposal-body p {
    font-size: 14px;
  }

  .proposal-footer {
    flex-direction: column;
    align-items: flex-start;
  }

  .view-details, .view-profile {
    padding: 10px 20px;
    font-size: 14px;
  }

  .modal-content {
    width: 90%;
  }

  .modal-description .row {
    flex-direction: column;
  }

  .modal-description .row p {
    margin: 5px 0;
  }
}

/* Responsive Design for Small Mobile Devices */
@media (max-width: 480px) {
  .proposals-container {
    width: 100%;
    padding: 10px;
  }

  .proposals-header h2 {
    font-size: 20px;
  }

  .proposal-item {
    padding: 10px;
  }

  .proposal-header h3 {
    font-size: 18px;
  }

  .proposal-body p {
    font-size: 12px;
  }

  .proposal-footer {
    flex-direction: column;
    align-items: flex-start;
    font-size: 12px;
  }

  .view-details, .view-profile {
    padding: 8px 16px;
    font-size: 12px;
  }

  .modal-content {
    width: 95%;
  }

  .modal-description .row {
    flex-direction: column;
  }

  .modal-description .row p {
    margin: 5px 0;
  }
}
  </style>
</head>
<body>
  <div class="proposals-container">
    <div class="proposals-header">
      <h2>Received Proposals</h2>
    </div>
    <ul class="proposal-list">
      {% for proposal in proposals %}
      <li class="proposal-item">
        <div class="proposal-header">
          <h3>Freelancer Name:</h3>
          <p>{{ proposal.freelancer.first_name }} {{ proposal.freelancer.last_name }}</p>
          <h3>Skills:</h3>
          <p>{{ proposal.freelancer.skills }}</p>
          <h3>Hourly Rate:</h3>
          <p>{{ proposal.freelancer.hourly_rate }}</p> <!-- Fixed missing closing `p` tag -->
        </div>
        
        <div class="details-section">
          <div class="info-group">
            <label for="project-title"><strong>Project Title:</strong></label>
            <span>{{ proposal.title }}</span>
          </div>

          <div class="info-group">
            <label for="project-description"><strong>Project Description:</strong></label>
            <span>{{proposal.description| truncatechars:200}}</span>
          </div>

          <div class="info-group">
            <span style="margin-top:10px;"><i class="fas fa-calendar-alt" style="color: #104a8e;"></i> Submitted on: {{ proposal.duration }}</span>
          </div> 
        </div>

        <div class="button-group">
          <button class="view-details" onclick="viewDetails('{{ proposal.title }}', '{{ proposal.description }}', '{{ proposal.duration }}', '{{ proposal.bid }}', '{{ proposal.cover_letter }}', '{{ proposal.attachment}}', '{{ proposal.submitted_at|date:"Y-m-d H:i:s" }}')">View Details</button>
         
          <a href="javascript:void(0);" class="view-details" onclick="startPayment({{proposal.id}}, {{proposal.bid}})">Approve and Payment</a>
          
        </div>        
      </li>
      {% endfor %}
    </ul>
  </div>


<!-- Details Modal -->
<div id="detailsModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('detailsModal')">&times;</span>
    <div class="modal-description" id="detailsContent">
      <!-- Proposal details will be dynamically inserted here -->
    </div>
    <!-- Select Project Button (Triggers Razorpay Payment) -->
  </div>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
    // Function to open a modal
    function openModal(modalId) {
        var modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = "block";
        }
    }

    // Function to close a modal
    function closeModal(modalId) {
        var modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = "none";
        }
    }

    // Start Razorpay Payment
    function startPayment(proposalId, bid) {
        // Fetch CSRF token
        const csrfToken = document.getElementById('csrf_token').value;

        // Make a request to create the Razorpay order
        fetch("{% url 'create_order' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ proposal_id: proposalId, bid: bid})
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                //alert('Error creating order: ' + data.error);
                alert("Internal Server Error, Try again after few moments")
                return;
            }

            var options = {
                key: '{{ RAZORPAY_KEY }}',  // Your Razorpay key
                amount: data.amount,        // Amount in paise
                currency: 'INR',
                name: 'WorkSphere',
                description: 'Payment for project proposal: ' + proposalId,
                order_id: data.order_id,    // Razorpay order ID
                handler: function (response) {
                    // Send payment details for verification
                    fetch("{% url 'verify_payment' %}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({
                            razorpay_order_id: response.razorpay_order_id,
                            razorpay_payment_id: response.razorpay_payment_id,
                            razorpay_signature: response.razorpay_signature
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            alert('Payment Successful!');
                            window.location.href = "{% url 'client_payment' %}"; // Redirect to success page
                        } else {
                            alert('Payment verification failed: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error verifying payment:', error);
                        alert('An error occurred during payment verification.');
                    });
                },
                prefill: {
                    name: "{{ user.username }}", // Pre-filled name from Django user object
                    email: "{{ user.email }}",   // Pre-filled email from Django user object
                    contact: "{{ user.phone_no }}" // Pre-filled contact number (assuming a 'phone_number' field in your user's profile)
                },
                theme: {
                    color: " #007bff;" // Customize color
                }
            };

            // Open Razorpay payment modal
            var rzp1 = new Razorpay(options);
            rzp1.open();
        })
        .catch(error => {
            console.error('Error creating order:', error);
            alert('An error occurred while initiating the payment.');
        });
    }
  
  // Function to show proposal details in the modal
  function viewDetails(title, description, duration, bid, coverLetter, attachmentUrl, submittedAt) {
    const modalDetails = `
      <h3 style="font-size: 20px; font-family: Verdana; text-align: center">Proposal Details</h3>
      <p style="font-size: 20px; font-family: Candara;"><strong>Title:</strong> ${title}</p>
      <div class="row" style="margin-bottom: 10px; justify-content: space-between;">
        <p style="margin: 0; flex-basis: 45%; font-size: 20px; font-family: Candara;"><strong>Description:</strong> ${description.length > 100 ? description.substring(0, 100) + '...' : description}</p>
      </div>
      <p style="font-size: 20px; font-family: Candara;"><strong>Duration:</strong> ${duration}</p>
      <p style="font-size: 20px; font-family: Candara;"><strong>Bid:</strong> Rs.  ${bid}</p>
      <div class="row" style="margin-bottom: 10px; justify-content: space-between;">
        <p style="margin: 0; flex-basis: 45%; font-size: 20px; font-family: Candara;"><strong>Cover Letter:</strong> ${coverLetter.length > 2000 ? coverLetter.substring(0, 2000) + '...' : coverLetter}</p>
      </div>
      <p style="font-size: 20px; font-family: Candara;"><strong>Submitted At:</strong> ${submittedAt}</p>
    `;
    document.getElementById('detailsContent').innerHTML = modalDetails;
    document.getElementById('detailsModal').style.display = 'block';
  }

  // Function to close the modal
  function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
  }
</script>
<!-- CSRF Token -->
<input type="hidden" id="csrf_token" value="{{ csrf_token }}">
</body>
</html>
{% endblock %}
